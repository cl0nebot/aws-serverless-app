# flog-rules-app

This is generated by AWS SAM CLI for coverage-reference-app - a golang lambda function that implement flogo rules for org-status validation.  Flogo-rules is a lightweight golang library for building context-aware, declarative rules. More details about Flogo-rules can be found [here](https://github.com/project-flogo/rules). Refer `test.sh` for examples about how to invoke this function.

```bash
.
├── Makefile                    <-- Make to automate build
├── README.md                   <-- This instructions file
├── coveragedata                <-- Source code for a lambda function
│   ├── main.go                 <-- Lambda function code
│   └── main_test.go            <-- Unit tests
│   └── flogo-rules.go          <-- Implementation of Flogo rules for org-status
└── deploy.yaml                 <-- Script to build and deploy the lambda to AWS
└── env.sh                      <-- Connection info of the deployed lambda function
└── template.yaml               <-- Generated by SAM CLI for lambda package and deploy
└── test.sh                     <-- Test for lambda function
```

## Requirements

* AWS CLI already configured with Administrator permission
* [Docker installed](https://www.docker.com/community-edition)
* [Golang](https://golang.org)

## Setup process

### Installing dependencies

In this implementation we use the built-in `go get` and the dependency of this app include AWS Lambda Go SDK, and Flogo-rules:

```shell
go get -u github.com/aws/aws-lambda-go/...
https://github.com/project-flogo/rules
```

### Building

Golang is a staticly compiled language, meaning that in order to run it you have to build the executeable target.

You can issue the following command in a shell to build it:

```shell
GOOS=linux GOARCH=amd64 go build -o flogo-rules/flogo-rules ./flogo-rules
```
or simply
```bash
make build
```
which has already been inlucded in the script `deploy.sh`

**NOTE**: If you're not building the function on a Linux machine, you will need to specify the `GOOS` and `GOARCH` environment variables, this allows Golang to build your function for another system architecture and ensure compatability.

### Local development

**Invoking function locally through local API Gateway**

```bash
sam local start-api
```

If the previous command ran successfully you should now be able to hit the following local endpoint to invoke your function `http://localhost:3000/rules`

**SAM CLI** is used to emulate both Lambda and API Gateway locally and uses the `template.yaml` to understand how to bootstrap this environment (runtime, where the source code is, etc.) - The following excerpt is what the CLI will read in order to initialize an API and its routes:

```yaml
...
Resources:
  FlogoRulesFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Properties:
      CodeUri: flogo-rules/
      Handler: flogo-rules
      Runtime: go1.x
      Tracing: Active # https://docs.aws.amazon.com/lambda/latest/dg/lambda-x-ray.html
      Events:
        CatchAll:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            Path: /rules
            Method: ANY
...
```
## Packaging and deployment

AWS Lambda runtime requires a flat folder with all dependencies including the application. SAM will use `CodeUri` property to know where to look up for both application and dependencies.

First and foremost, we need a `S3 bucket` where we can upload our Lambda functions packaged as ZIP before we deploy anything - The following script has already been included in the script `/poc/root/elasticache/create-all.sh`, which will create the `S3 bucket` for SAM:

```bash
aws s3 mb s3://BUCKET_NAME
```

Next, run the following command to package our Lambda function to S3:

```bash
sam package \
    --template-file template.yaml \
    --output-template-file packaged.yaml \
    --s3-bucket REPLACE_THIS_WITH_YOUR_S3_BUCKET_NAME
```

Next, the following command will create a Cloudformation Stack and deploy your SAM resources.

```bash
sam deploy \
    --template-file packaged.yaml \
    --stack-name flogo-rules-app \
    --capabilities CAPABILITY_IAM
```

Both steps are included in the `deploy.sh` script, so you do not have to execute them individually.

> **See [Serverless Application Model (SAM) HOWTO Guide](https://github.com/awslabs/serverless-application-model/blob/master/HOWTO.md) for more details in how to get started.**

After deployment is complete you can run the following command to retrieve the API Gateway Endpoint URL:

```bash
aws cloudformation describe-stacks \
    --stack-name flogo-rules-app \
    --query 'Stacks[].Outputs'
``` 
This step is also included in the `deploy.sh` script, and the result is updated in `env.sh` so it is ready to use by other service components and test scripts.

### Testing

We use `testing` package that is built-in in Golang and you can simply run the following command to run our tests:

```shell
go test -v ./flogo-rules/
```
# Appendix

### Golang installation

Please ensure Go 1.x (where 'x' is the latest version) is installed as per the instructions on the official golang website: https://golang.org/doc/install

A quickstart way would be to use Homebrew, chocolatey or your linux package manager.

#### Homebrew (Mac)

Issue the following command from the terminal:

```shell
brew install golang
```

If it's already installed, run the following command to ensure it's the latest version:

```shell
brew update
brew upgrade golang
```

#### Chocolatey (Windows)

Issue the following command from the powershell:

```shell
choco install golang
```

If it's already installed, run the following command to ensure it's the latest version:

```shell
choco upgrade golang
```
## AWS CLI commands

AWS CLI commands to package, deploy and describe outputs defined within the cloudformation stack:

```bash
sam package \
    --template-file template.yaml \
    --output-template-file packaged.yaml \
    --s3-bucket REPLACE_THIS_WITH_YOUR_S3_BUCKET_NAME

sam deploy \
    --template-file packaged.yaml \
    --stack-name flogo-rules-app \
    --capabilities CAPABILITY_IAM \
    --parameter-overrides MyParameterSample=MySampleValue

aws cloudformation describe-stacks \
    --stack-name flogo-rules-app --query 'Stacks[].Outputs'
```
